name: special â˜ assets/special

on:
  schedule:
    - cron: '0 18 * * *'  # UTCæ—¶é—´æ¯å¤©18ç‚¹ï¼ˆåŒ—äº¬æ—¶é—´æ¬¡æ—¥2ç‚¹ï¼‰æ‰§è¡Œ
  workflow_dispatch:      # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write         # å…è®¸æ¨é€ä»£ç åˆ°ä»“åº“

jobs:
  update:
    runs-on: ubuntu-latest
    name: æ•´ç†å¹¶æ›´æ–°ç‰¹æ®Šç›´æ’­æº

    steps:
      - name: ğŸ“¦ æ‹‰å–ä»“åº“ä»£ç 
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: å¼ºåˆ¶åŒæ­¥è¿œç¨‹ä»£ç 
        run: git fetch --prune && git reset --hard origin/main

      - name: ğŸ è®¾ç½® Python 3.10 ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: ğŸ”§ å®‰è£…ä¾èµ–ï¼ˆå†…ç½®urllibï¼Œæ— éœ€é¢å¤–åŒ…ï¼‰
        run: python -m pip install --upgrade pip

      - name: â–¶ï¸ æ‰§è¡Œç›´æ’­æºæ•´ç†è„šæœ¬
        run: python assets/special/special.py  # ä»ä»“åº“æ ¹ç›®å½•è¿è¡Œè„šæœ¬

      - name: ğŸ“‹ éªŒè¯è¾“å‡ºç»“æœ
        run: |
          echo "è¾“å‡ºæ–‡ä»¶å†…å®¹æ£€æŸ¥ï¼š"
          if [ -f "output/special/live_special.txt" ]; then
            echo "æ–‡ä»¶å­˜åœ¨ï¼Œå†…å®¹è¡Œæ•°ï¼š$(cat output/special/live_special.txt | wc -l)"
            echo "å‰5è¡Œé¢„è§ˆï¼š"
            head -n 5 output/special/live_special.txt
          else
            echo "é”™è¯¯ï¼šæœªç”Ÿæˆ output/special/live_special.txt"
            exit 1
          fi

      - name: ğŸ’¾ æäº¤å¹¶æ¨é€å˜æ›´
        run: |
          git config --local user.email "bot@github.com"
          git config --local user.name "Stable Bot"
          # è·Ÿè¸ªè„šæœ¬ã€é…ç½®æ–‡ä»¶å’Œè¾“å‡ºç»“æœ
          git add \
            assets/special/special.py \
            assets/special/urls.txt \
            assets/special/ExcludeList.txt \
            assets/special/rename.txt \
            output/special/
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
          if git diff --staged --quiet; then
            echo "âš ï¸ æ— æ›´æ–°å†…å®¹ï¼Œè·³è¿‡æäº¤"
            exit 0
          fi
          
          git commit -m "è‡ªåŠ¨æ›´æ–°ç‰¹æ®Šç›´æ’­æºï¼ˆ$(date +'%Y-%m-%d')ï¼‰"
          
          # å¤„ç†å†²çªå¹¶æ¨é€
          git pull origin main --rebase --autostash || {
            echo "å˜åŸºå†²çªï¼Œè‡ªåŠ¨ç”¨è¿œç¨‹æœ€æ–°ä»£ç è¦†ç›–æœ¬åœ°";
            git rebase --abort;
            git pull origin main --force;
          }
          git push origin main --force-with-lease || git push --force origin main
